if(!RichTextEditor.History){RichTextEditor.__KEY={ENTER:'13',DELETE:'46',SPACE:'32',BACKSPACE:'8',TAB:'9',PASTE:'86',CUT:'88'},Object.extend=function(_a,_b){for(var _c in _b){_a[_c]=_b[_c];}return _a;};(function(){function keepMaxLength(_e,_f){while(_e.length>=_f){_e.shift();}}var _a=1000;var _b=false,_c=true,_d=null;RichTextEditor.History=function(_e){this.maxUndoCount=_a;this.editor=_e;this.undoMementoList=_d;this.redoMementoList=_d;this.currentMemento=_d;this.contentModified=_b;this.setupHistory();};RichTextEditor.History.prototype={setupHistory:function(){this.initHistory({content:RichTextEditor.EMPTY_PARAGRAPH_HTML,scrollTop:0});},canUndo:function(){return this.undoMementoList.length>0;},canRedo:function(){return this.redoMementoList.length>0;},setCurrentMemento:function(_e){this.currentMemento=_e;},undoHandler:function(){var _e=this;_e.saveHistoryIfEdited();if(!_e.canUndo()){return;}var _f=_e.undoMementoList.pop();_f.undo();_e.redoMementoList.push(_f);_e.setCurrentMemento(_f);},redoHandler:function(){var _e=this;_e.saveHistoryIfEdited();if(!_e.canRedo()){return;}var _f=_e.redoMementoList.pop();_f.redo();_e.undoMementoList.push(_f);_e.setCurrentMemento(_f);},initHistory:function(_e){var _f=this;_f.undoMementoList=[];_f.redoMementoList=[];var _g=new RichTextEditor.Memento();var _h=Object.extend({content:RichTextEditor.EMPTY_PARAGRAPH_HTML,scrollTop:0},_e);_g.addUndoData(_h);_g.addHandler(_f.getTextHandler());_f.setCurrentMemento(_g);},saveHistory:function(_e,_f,_g){var _h=this;var _i=_h.undoMementoList;var _j=_h.currentMemento;_h.redoMementoList=[];if(arguments.length==3){_j.addUndoRedData(_e,_f,_g);}var _k=_h.getTextData();_j.addRedoData(_k);keepMaxLength(_i,_h.maxUndoCount);_i.push(_j);var _l=new RichTextEditor.Memento();_l.addHandler(_h.getTextHandler());_l.addUndoData(_k);_h.setCurrentMemento(_l);_h.contentModified=_b;},injectHistory:function(_e,_f,_g){if(!this.canUndo()){return;}var _h=this.undoMementoList;var _i=_h[_h.length-1];_i.addUndoRedData(_e,_f,_g);},saveHistoryIfEdited:function(){if(this.contentModified){this.saveHistory();}},saveHistoryByKeyEvent:function(_e){var _f={code:_e.keyCode,ctrl:_e.ctrlKey||(_e.keyCode===17),alt:_e.altKey||(_e.keyCode===18),shift:_e.shiftKey||(_e.keyCode===16)};if(_f.code==229){return;}var _g=this;if(_f.code==RichTextEditor.__KEY.ENTER||_f.code==RichTextEditor.__KEY.SPACE||_f.code==RichTextEditor.__KEY.TAB){_g.saveHistoryIfEdited();}else if(_f.code==RichTextEditor.__KEY.DELETE||_f.code==RichTextEditor.__KEY.BACKSPACE){_g.saveHistory();}else if((_f.code==RichTextEditor.__KEY.PASTE||_f.code==RichTextEditor.__KEY.CUT)&&_f.ctrl){_g.saveHistory();}else if(((_f.code>32&&_f.code<41)&&_f.shift)||(_f.code==65&&_f.ctrl)){_g.saveHistoryIfEdited();}else if(_f.ctrl||_f.alt||(_f.shift&&_f.code==16)){}else{_g.contentModified=_c;}},getTextHandler:function(){var _e=this.editor;var _f=this;return function(_g){_e.setContent(_g.content);var _h={start:0,end:0};var _i=_g.range||_h;_f.restoreRange(_i);if(RichTextEditor.Browser=="IE"){setTimeout(function(){RichTextEditor.DomUtil.setScrollTop(_e.editorDoc,_g.scrollTop);},0);}};},getTextData:function(){return {content:this.editor.getContent(),scrollTop:RichTextEditor.DomUtil.getScrollTop(this.editor.editorDoc),range:this.getRangeData()};}};if(RichTextEditor.Browser=="IE"){RichTextEditor.History.prototype.getRangeData=function(){var _e=this.editor.editorDoc;var _f=_e.body;try{var _g=_e.selection.createRange();}catch(e){return {start:0,end:0};}var _h=_e.body.createTextRange();_h.moveToElementText(_f);try{_h.setEndPoint("EndToStart",_g);var _i=_h.text.length;return {start:_i,end:_i+_g.text.length};}catch(e){}var _j=_h.text.length;return {start:_j,end:_j};};RichTextEditor.History.prototype.restoreRange=function(_e){var _f=this.editor.editorDoc;var _g=_f.body;var _h=_f.body.createTextRange();_h.moveToElementText(_g);_h.collapse(true);_h.moveEnd("character",_e.end);_h.moveStart("character",_e.start);_h.select();};}else{RichTextEditor.History.prototype.getRangeData=function(){var _e=this.editor.selection.getSelection();var _f=_e.rangeCount;var _g,_h;if(_f){var _i=_e.getRangeAt(0);var _j=_i.cloneRange();_j.selectNodeContents(this.editor.editorBody);_j.setEnd(_i.startContainer,_i.startOffset);_g=_j.toString().length;_h=_g+_i.toString().length;}else{_g=0;_h=0;}return {start:_g,end:_h};};RichTextEditor.History.prototype.restoreRange=function(_e){var _f=this.editor.editorBody;var _g=0,_h=this.editor.editorDoc.createRange();_h.setStart(_f,0);_h.collapse(true);var _i=[_f],_j,_k=false,_l=false;while(!_l&&(_j=_i.pop())){if(_j.nodeType==3){var _m=_g+_j.length;if(!_k&&_e.start>=_g&&_e.start<=_m){_h.setStart(_j,_e.start-_g);_k=true;}if(_k&&_e.end>=_g&&_e.end<=_m){_h.setEnd(_j,_e.end-_g);_l=true;}_g=_m;}else{var _n=_j.childNodes.length;while(_n-- ){_i.push(_j.childNodes[_n]);}}}var _o=this.editor.selection.getSelection();_o.removeAllRanges();_o.addRange(_h);};}RichTextEditor.Memento=function(){this.before={};this.after={};this.handlers=[];};RichTextEditor.Memento.prototype={addUndoRedData:function(_e,_f,_g){Object.extend(this.before,_e);Object.extend(this.after,_f);this.handlers.push(_g);},addHandler:function(_e){this.handlers.push(_e);},addUndoData:function(_e){Object.extend(this.before,_e);},addRedoData:function(_e){Object.extend(this.after,_e);},undo:function(){var _e=this;RichTextEditor.Lib.array.Each(_e.handlers,function(_f){_f(_e.before);});},redo:function(){var _e=this;RichTextEditor.Lib.array.Each(_e.handlers,function(_f){_f(_e.after);});}};})();}