<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="SAL050205_SQL">	
	
	<!-- 종전근무소득정보 목록조회 -->
	<select id="SAL050205DAO.selectYndBeforeWorkList" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		<![CDATA[		 
	        SELECT 
					 A.EXCCLC_YEAR
					,A.EXCCLC_SE
					,A.EMPNO
					,A.INCOME_SE
					,B.EMPNM
					,A.WRKPLC_NM
					,A.BIZRNO
					,A.SALARY_TOTAMT
					,A.BNS_TOTAMT
					,A.TAXXMPT_OUTNATN_ERNM
					,A.TAXXMPT_NIGHT_ERNM
					,A.TAXXMPT_ETC_INCOME
					,A.INCMTAX
					,A.LCLTY_INCMTAX
					,A.AGSPT
					,A.PAY_ENDW
					,A.HLTHINS
					,A.NPN
					,A.EMPLYMINSRNC
					,A.WORK_BEGIN_DE
					,A.WORK_ENDDE
			FROM TBSAL_YND_EXCCLC_BEFORE_WORK  A	
			    ,TBHRM_HR_MASTR B	
			WHERE A.EXCCLC_YEAR = #EXCCLC_YEAR#
			AND A.EXCCLC_SE = #EXCCLC_SE#
			AND A.EMPNO = B.EMPNO
		]]>	  
		<isNotEmpty property="EMPNO">
	 	    AND A.EMPNO = #EMPNO#
		</isNotEmpty> 
    </select>  
    
       
    <!-- 종전근무소득정보 입력 -->
    <insert id="SAL050205DAO.YndBeforeWorkC" parameterClass="java.util.HashMap">
        <![CDATA[
            INSERT INTO TBSAL_YND_EXCCLC_BEFORE_WORK (
                         EXCCLC_YEAR
						,EXCCLC_SE
						,EMPNO
						,INCOME_SE
						,EMPNM
						,WRKPLC_NM
						,BIZRNO
						,SALARY_TOTAMT
						,BNS_TOTAMT
						,TAXXMPT_OUTNATN_ERNM
						,TAXXMPT_NIGHT_ERNM
						,TAXXMPT_ETC_INCOME
						,INCMTAX
						,LCLTY_INCMTAX
						,AGSPT
						,PAY_ENDW
						,HLTHINS
						,NPN
						,EMPLYMINSRNC
						,WORK_BEGIN_DE
						,WORK_ENDDE
						,REGISTER_ID
						,REGIST_DT
						,UPDUSR_ID
						,UPDT_DT
             ) VALUES (
	                     #EXCCLC_YEAR#
						,#EXCCLC_SE#
						,#EMPNO#
						,(SELECT NVL(MAX(INCOME_SE),0) + 1 FROM TBSAL_YND_EXCCLC_BEFORE_WORK WHERE EXCCLC_YEAR = #EXCCLC_YEAR#
						  AND EXCCLC_SE = #EXCCLC_SE# AND EMPNO = #EMPNO# )
						,#EMPNM#
						,#WRKPLC_NM#
						,#BIZRNO#
						,#SALARY_TOTAMT#
						,#BNS_TOTAMT#
						,#TAXXMPT_OUTNATN_ERNM#
						,#TAXXMPT_NIGHT_ERNM#
						,#TAXXMPT_ETC_INCOME#
						,#INCMTAX#
						,#LCLTY_INCMTAX#
						,#AGSPT#
						,#PAY_ENDW#
						,#HLTHINS#
						,#NPN#
						,#EMPLYMINSRNC#
						,#WORK_BEGIN_DE#
						,#WORK_ENDDE#
	                    ,#S_USER_ID#
	                    ,SYSDATE
	                    ,#S_USER_ID#               
	                    ,SYSDATE
             )
        ]]>
    </insert>


    <!-- 종전근무소득정보 수정 -->
    <update id="SAL050205DAO.YndBeforeWorkU" parameterClass="java.util.HashMap">
        <![CDATA[
            UPDATE TBSAL_YND_EXCCLC_BEFORE_WORK A SET
                 WRKPLC_NM              = #WRKPLC_NM#
                ,BIZRNO                 = #BIZRNO# 
                ,SALARY_TOTAMT          = #SALARY_TOTAMT#
                ,BNS_TOTAMT             = #BNS_TOTAMT#
                ,TAXXMPT_OUTNATN_ERNM   = #TAXXMPT_OUTNATN_ERNM# 
                ,TAXXMPT_NIGHT_ERNM     = #TAXXMPT_NIGHT_ERNM#
				,TAXXMPT_ETC_INCOME     = #TAXXMPT_ETC_INCOME#
                ,INCMTAX                = #INCMTAX#
				,LCLTY_INCMTAX          = #LCLTY_INCMTAX#
				,AGSPT                  = #AGSPT#
				,PAY_ENDW               = #PAY_ENDW#
				,HLTHINS                = #HLTHINS#
				,NPN                    = #NPN#
				,EMPLYMINSRNC           = #EMPLYMINSRNC#
				,WORK_BEGIN_DE          = #WORK_BEGIN_DE#
				,WORK_ENDDE             = #WORK_ENDDE#                
                ,UPDUSR_ID		       = #S_USER_ID#
                ,UPDT_DT		       = SYSDATE
            WHERE A.EXCCLC_YEAR = #EXCCLC_YEAR#
			AND A.EXCCLC_SE = #EXCCLC_SE#
			AND A.EMPNO = #EMPNO#
			AND A.INCOME_SE = #INCOME_SE#
        ]]>    
    </update>


    <!-- 종전근무소득정보 삭제 -->
    <delete id="SAL050205DAO.YndBeforeWorkD" parameterClass="java.util.HashMap">
        <![CDATA[
            DELETE FROM TBSAL_YND_EXCCLC_BEFORE_WORK A
            WHERE A.EXCCLC_YEAR = #EXCCLC_YEAR#
			AND A.EXCCLC_SE = #EXCCLC_SE#
			AND A.EMPNO = #EMPNO#
			AND A.INCOME_SE = #INCOME_SE#
        ]]>    
    </delete>    
   
	<!-- 종전근무소득정보 수정 -->
	<update id="SAL050205DAO.YndExcclcBsisU" parameterClass="java.util.HashMap">
		<![CDATA[
			UPDATE TBSAL_YND_EXCCLC_BSIS A
			SET FYER_LABOR_INCOME = 	  (SELECT NVL(SUM(TOT_PYMNTAMT),0) FROM TBSAL_MT_SALARY_PYMNT WHERE PYMNT_YM LIKE #EXCCLC_YEAR#||'%' AND EMPNO = A.EMPNO)
										+ (SELECT NVL(SUM(PYMNT_SM_AMOUNT),0) FROM TBSAL_PD_WORK_SALARY WHERE PYMNT_YM LIKE #EXCCLC_YEAR#||'%' AND EMPNO = A.EMPNO)
										+ (SELECT NVL(SUM(SALARY_TOTAMT),0)+NVL(SUM(BNS_TOTAMT),0) FROM TBSAL_YND_EXCCLC_BEFORE_WORK WHERE EXCCLC_YEAR = #EXCCLC_YEAR# AND EMPNO = A.EMPNO)
			    , TAXXMPT_INCOME =	      (SELECT NVL(SUM(TAXXMPT_AMOUNT),0) FROM TBSAL_MT_SALARY_PYMNT WHERE PYMNT_YM LIKE #EXCCLC_YEAR#||'%' AND EMPNO = A.EMPNO)
										+ (SELECT NVL(SUM(ALLWNC_AMOUNT), 0)
											FROM (
													SELECT EMPNO, PYMNT_YM, CASE WHEN SUM(ALLWNC_AMOUNT) > 100000 THEN 100000 ELSE SUM(ALLWNC_AMOUNT) END ALLWNC_AMOUNT
													FROM TBSAL_FAMILY_ALLWNC_MANAGE C1
													WHERE PYMNT_YM LIKE #EXCCLC_YEAR#||'%'
													AND FLOOR( MONTHS_BETWEEN( TO_DATE(#EXCCLC_YEAR#||'0101', 'YYYYMMDD'), TO_DATE( C1.BRTHDY, 'YYYYMMDD' ) )/12) <=  6
													GROUP BY EMPNO, PYMNT_YM
											)ST
											WHERE A.EMPNO = ST.EMPNO)
										+ (SELECT NVL(SUM(	CASE WHEN PD_WORK_SALARY_TYPE = #EXCCLC_SE# THEN NVL(MLSV_SBSIDY, 0)
															WHEN PD_WORK_SALARY_TYPE = '2' THEN CASE WHEN NVL(TAXXMPT_AMOUNT,0) > 100000 THEN 100000 ELSE NVL(TAXXMPT_AMOUNT,0) END
															ELSE 0 END),0)
											FROM TBSAL_PD_WORK_SALARY WHERE PYMNT_YM LIKE #EXCCLC_YEAR#||'%' AND EMPNO = A.EMPNO)	
										+ (SELECT NVL(SUM(TAXXMPT_OUTNATN_ERNM),0)+NVL(SUM(TAXXMPT_NIGHT_ERNM),0)+NVL(SUM(TAXXMPT_ETC_INCOME),0) FROM TBSAL_YND_EXCCLC_BEFORE_WORK WHERE EXCCLC_YEAR = #EXCCLC_YEAR# AND EMPNO = A.EMPNO)
				, TOT_SALARY_AMOUNT = 	  (SELECT NVL(SUM(TAXT_AMOUNT),0) FROM TBSAL_MT_SALARY_PYMNT WHERE PYMNT_YM LIKE #EXCCLC_YEAR#||'%' AND EMPNO = A.EMPNO)
										- (SELECT NVL(SUM(ALLWNC_AMOUNT), 0)
											FROM (
													SELECT EMPNO, PYMNT_YM, CASE WHEN SUM(ALLWNC_AMOUNT) > 100000 THEN 100000 ELSE SUM(ALLWNC_AMOUNT) END ALLWNC_AMOUNT
													FROM TBSAL_FAMILY_ALLWNC_MANAGE C1
													WHERE PYMNT_YM LIKE #EXCCLC_YEAR#||'%'
													AND FLOOR( MONTHS_BETWEEN( TO_DATE(#EXCCLC_YEAR#||'0101', 'YYYYMMDD'), TO_DATE( C1.BRTHDY, 'YYYYMMDD' ) )/12) <=  6
													GROUP BY EMPNO, PYMNT_YM
											)ST
											WHERE A.EMPNO = ST.EMPNO)
										+ (SELECT NVL(SUM(	CASE WHEN PD_WORK_SALARY_TYPE = #EXCCLC_SE# THEN NVL(PYMNT_SM_AMOUNT, 0) - NVL(MLSV_SBSIDY, 0)
															WHEN PD_WORK_SALARY_TYPE = '2' THEN NVL(TAXT_AMOUNT,0) + CASE WHEN NVL(TAXXMPT_AMOUNT,0) > 100000 THEN NVL(TAXXMPT_AMOUNT,0) - 100000 ELSE 0 END
															ELSE 0 END),0)
											FROM TBSAL_PD_WORK_SALARY WHERE PYMNT_YM LIKE #EXCCLC_YEAR#||'%' AND EMPNO = A.EMPNO)	
										+ (SELECT NVL(SUM(SALARY_TOTAMT),0)+NVL(SUM(BNS_TOTAMT),0) - (NVL(SUM(TAXXMPT_OUTNATN_ERNM),0)+NVL(SUM(TAXXMPT_NIGHT_ERNM),0)+NVL(SUM(TAXXMPT_ETC_INCOME),0)) FROM TBSAL_YND_EXCCLC_BEFORE_WORK WHERE EXCCLC_YEAR = #EXCCLC_YEAR# AND EMPNO = A.EMPNO)
				, NPN = 				  (SELECT NVL(SUM(DDC_AMOUNT),0) FROM TBSAL_MT_DDC_DTLS WHERE PYMNT_DDC_CODE = 'S2120' AND EMPNO = A.EMPNO AND PYMNT_YM LIKE #EXCCLC_YEAR#||'%')
										+ (SELECT NVL(SUM(NPN),0) FROM TBSAL_PD_WORK_SALARY WHERE PYMNT_YM LIKE #EXCCLC_YEAR#||'%' AND EMPNO = A.EMPNO)
										+ (SELECT NVL(SUM(NPN),0) FROM TBSAL_YND_EXCCLC_BEFORE_WORK WHERE EXCCLC_YEAR = #EXCCLC_YEAR# AND EMPNO = A.EMPNO)
				, HLTHINS = 			  (SELECT NVL(SUM(DDC_AMOUNT),0) FROM TBSAL_MT_DDC_DTLS WHERE PYMNT_DDC_CODE = 'S2110' AND EMPNO = A.EMPNO AND PYMNT_YM LIKE #EXCCLC_YEAR#||'%')
										+ (SELECT NVL(SUM(HLTHINS),0) FROM TBSAL_PD_WORK_SALARY WHERE PYMNT_YM LIKE #EXCCLC_YEAR#||'%' AND EMPNO = A.EMPNO)
										+ (SELECT NVL(SUM(HLTHINS),0) FROM TBSAL_YND_EXCCLC_BEFORE_WORK WHERE EXCCLC_YEAR = #EXCCLC_YEAR# AND EMPNO = A.EMPNO)
				, EMPLYMINSRNC = 		  (SELECT NVL(SUM(DDC_AMOUNT),0) FROM TBSAL_MT_DDC_DTLS WHERE PYMNT_DDC_CODE = 'S2150' AND EMPNO = A.EMPNO AND PYMNT_YM LIKE #EXCCLC_YEAR#||'%')
										+ (SELECT NVL(SUM(EMPLYMINSRNC),0) FROM TBSAL_PD_WORK_SALARY WHERE PYMNT_YM LIKE #EXCCLC_YEAR#||'%' AND EMPNO = A.EMPNO)
										+ (SELECT NVL(SUM(EMPLYMINSRNC),0) FROM TBSAL_YND_EXCCLC_BEFORE_WORK WHERE EXCCLC_YEAR = #EXCCLC_YEAR# AND EMPNO = A.EMPNO)
			WHERE EXCCLC_YEAR = #EXCCLC_YEAR#
			AND   EXCCLC_SE = #EXCCLC_SE#
			AND	EMPNO = #EMPNO#
		]]>    
	</update>

</sqlMap>