<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="ACC030201_SQL">	
	
	<!-- 원천징수 총괄납부 -->
	<select id="ACC030201DAO.wthtxSmrizePayList" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		<![CDATA[ /*ACC030201DAO.wthtxSmrizePayList*/ ]]>
		WITH TM_WTHTX_STTUS AS (
			SELECT t1.DECSN_YEAR
			     , t1.DECSN_NO
			     , t1.CPTAL_EXPNDTR_ACNTBK_DE
			     , t3.WHTAX_KND
			     , MAX(t4.SBJECT_CODE_NM) AS WHTAX_NM
			     , MAX(t1.SUMRY) AS SUMRY
			     , MIN(t3.NM) KEEP(DENSE_RANK FIRST  ORDER BY t3.SEQ ASC) || CASE WHEN COUNT(t3.NM) <![CDATA[>]]> 1 THEN '외 ' || TO_CHAR(COUNT(t3.NM)-1) ELSE '' END AS RCPT_MAN
			     , COUNT(t3.RCPT_MAN) AS DECSN_CNT
			     , NVL(SUM(t3.WHTAX_PYMNT_TOTAMT),0) AS DECSN_AMOUNT
			     , NVL(SUM(t3.INCMTAX),0) AS INCMTAX /*소득세*/
			     , NVL(SUM(t3.IHNTS),0) AS IHNTS /*지방소득세(주민세)*/
			FROM TBACC_EXP_DSN_MASTR t1
			  INNER JOIN TBACC_EXP_DSN_DETAIL t3
			  ON  t1.DECSN_YEAR  = t3.DECSN_YEAR
			  AND t1.DECSN_NO    = t3.DECSN_NO
			  LEFT OUTER JOIN TBACC_SBJECT_CODE t4
			  ON  t3.WHTAX_KND   = t4.SBJECT_CODE
			WHERE t3.WHTAX_AT = '1' /*원천세여부*/
			AND   t1.CPTAL_EXPNDTR_ACNTBK_DE BETWEEN #SRCH_ST_DT# AND #SRCH_ED_DT#
			GROUP BY t1.DECSN_YEAR, t1.DECSN_NO, t1.CPTAL_EXPNDTR_ACNTBK_DE, t3.WHTAX_KND
			UNION ALL
			/*임원/정규직 근로소득*/
			SELECT SUBSTR(A.PYMNT_DE,1,4) AS DECSN_YEAR
			     , ''         AS DECSN_NO
			     , A.PYMNT_DE AS CPTAL_EXPNDTR_ACNTBK_DE
			     , '44'       AS WHTAX_KND
			     , '근로소득'  AS WHTAX_NM 
			     , TO_NUMBER(SUBSTR(A.PYMNT_DE,5,2)) || '월분 임직원 급여 원천징수' AS SUMRY
			     , MIN(A.EMPNM) KEEP(DENSE_RANK FIRST  ORDER BY A.CLSF_CODE ASC) || CASE WHEN COUNT(A.EMPNO) <![CDATA[>]]> 1 THEN '외 ' || TO_CHAR(COUNT(A.EMPNM)-1) ELSE '' END AS EMPNM
			     , COUNT(A.EMPNO)
			     , NVL(SUM(A.TAXT_AMOUNT),0)   AS DECSN_AMOUNT
			     , NVL(SUM(A.INCMTAX),0)       AS INCMTAX
			     , NVL(SUM(A.LCLTY_INCMTAX),0) AS IHNTS
			FROM TBSAL_MT_SALARY_PYMNT A
			WHERE A.CLOS_AT  = '1'
			AND A.CLOS_DE    IS NOT NULL
			/* AND A.PYMNT_YM   = '201506' */
			AND A.PYMNT_DE   BETWEEN #SRCH_ST_DT# AND #SRCH_ED_DT#
			AND A.PYMNT_SE   = '2' /*20일자급여*/
			AND NVL(A.EMPL_SE, '004') <![CDATA[<>]]> '004' /*계약직제외*/
			GROUP BY A.PYMNT_DE
			UNION ALL
			/*계약직 근로소득*/
			SELECT SUBSTR(A.PYMNT_DE,1,4) AS DECSN_YEAR
			     , ''         AS DECSN_NO
			     , A.PYMNT_DE AS CPTAL_EXPNDTR_ACNTBK_DE
			     , '44'       AS WHTAX_KND
			     , '근로소득'  AS WHTAX_NM 
			     , TO_NUMBER(SUBSTR(A.PYMNT_DE,5,2)) || '월분 계약직직원 급여 원천징수' AS SUMRY
			     , MIN(A.EMPNM) KEEP(DENSE_RANK FIRST  ORDER BY A.EMPNO ASC) || CASE WHEN COUNT(A.EMPNO) <![CDATA[>]]> 1 THEN '외 ' || TO_CHAR(COUNT(A.EMPNM)-1) ELSE '' END AS EMPNM
			     , COUNT(A.EMPNO)
			     , NVL(SUM(A.TAXT_AMOUNT),0)   AS DECSN_AMOUNT
			     , NVL(SUM(A.INCMTAX),0)       AS INCMTAX
			     , NVL(SUM(A.LCLTY_INCMTAX),0) AS IHNTS
			FROM TBSAL_MT_SALARY_PYMNT A
			WHERE A.CLOS_AT  = '1'
			AND A.CLOS_DE    IS NOT NULL
			AND A.PYMNT_DE   BETWEEN #SRCH_ST_DT# AND #SRCH_ED_DT#
			AND A.PYMNT_SE   = '2' /*20일자급여*/
			AND A.EMPL_SE    = '004' /*계약직 ONLY*/
			GROUP BY A.PYMNT_DE
			/*기간제 일용소득*/
			UNION ALL
			SELECT SUBSTR(PYMNT_DE,1,4) AS DECSN_YEAR
			     , ''         AS DECSN_NO
			     , PYMNT_DE AS CPTAL_EXPNDTR_ACNTBK_DE
			     , '45'       AS WHTAX_KND
			     , '일용소득'  AS WHTAX_NM 
			     , TO_NUMBER(SUBSTR(PYMNT_DE,5,2)) || '월분 기간제근로자 급여 원천징수' AS SUMRY
			     , MIN(EMPNM) KEEP(DENSE_RANK FIRST  ORDER BY EMPNO ASC) || CASE WHEN COUNT(EMPNO) <![CDATA[>]]> 1 THEN '외 ' || TO_CHAR(COUNT(EMPNM)-1) ELSE '' END AS EMPNM
			     , COUNT(EMPNO)
			     , NVL(SUM(PYMNT_SM_AMOUNT),0) AS DECSN_AMOUNT
			     , NVL(SUM(INCMTAX),0)         AS INCMTAX
			     , NVL(SUM(LCLTY_INCMTAX),0)   AS IHNTS
			FROM TBSAL_PD_WORK_SALARY
			WHERE PYMNT_DE   BETWEEN #SRCH_ST_DT# AND #SRCH_ED_DT#
			AND   CLOS_AT  = '1'
			AND   CLOS_DE    IS NOT NULL
			GROUP BY PYMNT_DE 
		)
		SELECT
		     A.SBJECT_CODE
		    ,A.SBJECT_CODE_NM
		    ,NVL(B.DECSN_CNT,0) AS DECSN_CNT
		    ,NVL(B.DECSN_AMOUNT,0) AS DECSN_AMOUNT
		    ,NVL(B.INCMTAX,0) AS INCMTAX
		    ,NVL(B.IHNTS,0) AS IHNTS
		FROM TBACC_SBJECT_CODE A
		     LEFT OUTER JOIN
		     (SELECT WHTAX_KND
		            ,SUM(DECSN_CNT) AS DECSN_CNT
		            ,SUM(DECSN_AMOUNT) AS DECSN_AMOUNT
		            ,SUM(INCMTAX) AS INCMTAX
		            ,SUM(IHNTS) AS IHNTS
		      FROM TM_WTHTX_STTUS
		      GROUP BY WHTAX_KND
		     ) B
		     ON A.SBJECT_CODE = B.WHTAX_KND
		WHERE A.WHTAX_AT = '1'
	</select>
	
	<!-- 원천징수현황 -->
	<select id="ACC030201DAO.wthtxSttusList" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		<![CDATA[ /*ACC030201DAO.wthtxSttusList*/ ]]>
		WITH TM_WTHTX_STTUS AS (
			SELECT t1.DECSN_YEAR
			     , t1.DECSN_NO
			     , t1.CPTAL_EXPNDTR_ACNTBK_DE
			     , t3.WHTAX_KND
			     , MAX(t4.SBJECT_CODE_NM) AS WHTAX_NM
			     , MAX(t1.SUMRY) AS SUMRY
			     , MIN(t3.NM) KEEP(DENSE_RANK FIRST  ORDER BY t3.SEQ ASC) || CASE WHEN COUNT(t3.NM) <![CDATA[>]]> 1 THEN '외 ' || TO_CHAR(COUNT(t3.NM)-1) ELSE '' END AS RCPT_MAN
			     , COUNT(t3.RCPT_MAN) AS DECSN_CNT
			     , NVL(SUM(t3.WHTAX_PYMNT_TOTAMT),0) AS DECSN_AMOUNT
			     , NVL(SUM(t3.INCMTAX),0) AS INCMTAX /*소득세*/
			     , NVL(SUM(t3.IHNTS),0) AS IHNTS /*지방소득세(주민세)*/
			FROM TBACC_EXP_DSN_MASTR t1
			  INNER JOIN TBACC_EXP_DSN_DETAIL t3
			  ON  t1.DECSN_YEAR  = t3.DECSN_YEAR
			  AND t1.DECSN_NO    = t3.DECSN_NO
			  LEFT OUTER JOIN TBACC_SBJECT_CODE t4
			  ON  t3.WHTAX_KND   = t4.SBJECT_CODE
			WHERE t3.WHTAX_AT = '1' /*원천세여부*/
			AND   t1.CPTAL_EXPNDTR_ACNTBK_DE BETWEEN #SRCH_ST_DT# AND #SRCH_ED_DT#
			GROUP BY t1.DECSN_YEAR, t1.DECSN_NO, t1.CPTAL_EXPNDTR_ACNTBK_DE, t3.WHTAX_KND
			UNION ALL
			/*임원/정규직 근로소득*/
			SELECT SUBSTR(A.PYMNT_DE,1,4) AS DECSN_YEAR
			     , ''         AS DECSN_NO
			     , A.PYMNT_DE AS CPTAL_EXPNDTR_ACNTBK_DE
			     , '44'       AS WHTAX_KND
			     , '근로소득'  AS WHTAX_NM 
			     , TO_NUMBER(SUBSTR(A.PYMNT_DE,5,2)) || '월분 임직원 급여 원천징수' AS SUMRY
			     , MIN(A.EMPNM) KEEP(DENSE_RANK FIRST  ORDER BY A.CLSF_CODE ASC) || CASE WHEN COUNT(A.EMPNO) <![CDATA[>]]> 1 THEN '외 ' || TO_CHAR(COUNT(A.EMPNM)-1) ELSE '' END AS EMPNM
			     , COUNT(A.EMPNO)
			     , NVL(SUM(A.TAXT_AMOUNT),0)   AS DECSN_AMOUNT
			     , NVL(SUM(A.INCMTAX),0)       AS INCMTAX
			     , NVL(SUM(A.LCLTY_INCMTAX),0) AS IHNTS
			FROM TBSAL_MT_SALARY_PYMNT A
			WHERE A.CLOS_AT  = '1'
			AND A.CLOS_DE    IS NOT NULL
			/* AND A.PYMNT_YM   = '201506' */
			AND A.PYMNT_DE   BETWEEN #SRCH_ST_DT# AND #SRCH_ED_DT#
			AND A.PYMNT_SE   = '2' /*20일자급여*/
			AND NVL(A.EMPL_SE, '004') <![CDATA[<>]]> '004' /*계약직제외*/
			GROUP BY A.PYMNT_DE
			UNION ALL
			/*계약직 근로소득*/
			SELECT SUBSTR(A.PYMNT_DE,1,4) AS DECSN_YEAR
			     , ''         AS DECSN_NO
			     , A.PYMNT_DE AS CPTAL_EXPNDTR_ACNTBK_DE
			     , '44'       AS WHTAX_KND
			     , '근로소득'  AS WHTAX_NM 
			     , TO_NUMBER(SUBSTR(A.PYMNT_DE,5,2)) || '월분 계약직직원 급여 원천징수' AS SUMRY
			     , MIN(A.EMPNM) KEEP(DENSE_RANK FIRST  ORDER BY A.EMPNO ASC) || CASE WHEN COUNT(A.EMPNO) <![CDATA[>]]> 1 THEN '외 ' || TO_CHAR(COUNT(A.EMPNM)-1) ELSE '' END AS EMPNM
			     , COUNT(A.EMPNO)
			     , NVL(SUM(A.TAXT_AMOUNT),0)   AS DECSN_AMOUNT
			     , NVL(SUM(A.INCMTAX),0)       AS INCMTAX
			     , NVL(SUM(A.LCLTY_INCMTAX),0) AS IHNTS
			FROM TBSAL_MT_SALARY_PYMNT A
			WHERE A.CLOS_AT  = '1'
			AND A.CLOS_DE    IS NOT NULL
			AND A.PYMNT_DE   BETWEEN #SRCH_ST_DT# AND #SRCH_ED_DT#
			AND A.PYMNT_SE   = '2' /*20일자급여*/
			AND A.EMPL_SE    = '004' /*계약직 ONLY*/
			GROUP BY A.PYMNT_DE
			/*기간제 일용소득*/
			UNION ALL
			SELECT SUBSTR(PYMNT_DE,1,4) AS DECSN_YEAR
			     , ''         AS DECSN_NO
			     , PYMNT_DE AS CPTAL_EXPNDTR_ACNTBK_DE
			     , '45'       AS WHTAX_KND
			     , '일용소득'  AS WHTAX_NM 
			     , TO_NUMBER(SUBSTR(PYMNT_DE,5,2)) || '월분 기간제근로자 급여 원천징수' AS SUMRY
			     , MIN(EMPNM) KEEP(DENSE_RANK FIRST  ORDER BY EMPNO ASC) || CASE WHEN COUNT(EMPNO) <![CDATA[>]]> 1 THEN '외 ' || TO_CHAR(COUNT(EMPNM)-1) ELSE '' END AS EMPNM
			     , COUNT(EMPNO)
			     , NVL(SUM(PYMNT_SM_AMOUNT),0) AS DECSN_AMOUNT
			     , NVL(SUM(INCMTAX),0)         AS INCMTAX
			     , NVL(SUM(LCLTY_INCMTAX),0)   AS IHNTS
			FROM TBSAL_PD_WORK_SALARY
			WHERE PYMNT_DE   BETWEEN #SRCH_ST_DT# AND #SRCH_ED_DT#
			AND   CLOS_AT  = '1'
			AND   CLOS_DE    IS NOT NULL
			GROUP BY PYMNT_DE 
		)
		SELECT DECSN_YEAR, DECSN_NO, CPTAL_EXPNDTR_ACNTBK_DE, WHTAX_KND, WHTAX_NM, SUMRY, RCPT_MAN, DECSN_CNT, DECSN_AMOUNT, INCMTAX, IHNTS
		FROM TM_WTHTX_STTUS
		WHERE WHTAX_KND = #WHTAX_KND#
	</select>
	
</sqlMap>